## Maddy Mail Server - configuration file (generated by installer)
# Generated on: {{.Generated}}
# Suitable for small-scale deployments. Uses its own format for local users DB,
# should be managed via maddy subcommands.
#
# See tutorials at https://maddy.email for guidance on typical
# configuration changes.

# ----------------------------------------------------------------------------
# Base variables

$(hostname) = {{.Hostname}}
$(primary_domain) = {{.PrimaryDomain}}
$(local_domains) = {{.LocalDomains}}
$(public_ip) = {{.PublicIP}}
state_dir {{.StateDir}}
runtime_dir {{.RuntimeDir}}

tls file {{.TLSCertPath}} {{.TLSKeyPath}}

{{if .Debug}}debug yes
log stderr
{{else if .NoLog}}# Disable logging as requested
log off
{{else}}log stderr{{end}}

# ----------------------------------------------------------------------------
# Local storage & authentication

# pass_table provides local hashed passwords storage for authentication of
# users. It can be configured to use any "table" module, in default
# configuration a table in SQLite DB is used.
# Table can be replaced to use e.g. a file for passwords. Or pass_table module
# can be replaced altogether to use some external source of credentials (e.g.
# PAM, /etc/shadow file).
#
# If table module supports it (sql_table does) - credentials can be managed
# using 'maddy creds' command.

auth.pass_table local_authdb {
    auto_create yes
    table sql_table {
        driver sqlite3
        dsn credentials.db
        table_name passwords
    }
}

# imapsql module stores all indexes and metadata necessary for IMAP using a
# relational database. It is used by IMAP endpoint for mailbox access and
# also by SMTP & Submission endpoints for delivery of local messages.
#
# IMAP accounts, mailboxes and all message metadata can be inspected using
# imap-* subcommands of maddy.

storage.imapsql local_mailboxes {
    auto_create yes
    driver sqlite3
    dsn imapsql.db
    retention 24h
    default_quota 1G
    appendlimit {{.MaxMessageSize}}
}

# ----------------------------------------------------------------------------
# SMTP endpoints + message routing

hostname $(hostname)

table.chain local_rewrites {
    optional_step regexp "(.+)\+(.+)@(.+)" "$1@$3"
    optional_step static {
        entry postmaster postmaster@$(primary_domain)
    }
    optional_step file /etc/maddy/aliases
}

msgpipeline local_routing {
    # Insert handling for special-purpose local domains here.
    # e.g.
    # destination lists.example.org {
    #     deliver_to lmtp tcp://127.0.0.1:8024
    # }

    destination postmaster $(local_domains) {
        modify {
            replace_rcpt &local_rewrites
        }

        deliver_to &local_mailboxes
    }

    default_destination {
        reject 550 5.1.1 "User doesn't exist"
    }
}

smtp tcp://0.0.0.0:{{.SMTPPort}} {
    limits {
        # Up to 20 msgs/sec across max. 200 SMTP connections.
        all rate 20 1s
        all concurrency 200
    }

    max_message_size {{.MaxMessageSize}}

    dmarc yes
    check {
        require_tls
        require_mx_record
        dkim
        spf
    }

    source $(local_domains) {
        reject 501 5.1.8 "Use Submission for outgoing SMTP"
    }
    default_source {
        destination postmaster $(local_domains) {
            deliver_to &local_routing
        }
        default_destination {
            reject 550 5.1.1 "User doesn't exist"
        }
    }
}

submission tls://0.0.0.0:{{.SubmissionTLS}} tcp://0.0.0.0:{{.SubmissionPort}} {
    limits {
        # Up to 50 msgs/sec across any amount of SMTP connections.
        all rate 50 1s
    }

    max_message_size {{.MaxMessageSize}}

    auth &local_authdb
    insecure_auth {{if .AllowInsecureAuth}}yes{{else}}no{{end}}

    source $(local_domains) {
        check {
            require_tls
            authorize_sender {
                prepare_email &local_rewrites
                user_to_email identity
            }
{{if .RequirePGPEncryption}}
            pgp_encryption {
                require_encryption {{.RequirePGPEncryption}}
                allow_secure_join {{.AllowSecureJoin}}
                {{if .PGPPassthroughSenders}}
                passthrough_senders {{range .PGPPassthroughSenders}}{{.}} {{end}}
                {{end}}
                {{if .PGPPassthroughRecipients}}
                passthrough_recipients {{range .PGPPassthroughRecipients}}{{.}} {{end}}
                {{end}}
            }
{{end}}
        }

        destination postmaster $(local_domains) {
            deliver_to &local_routing
        }
        default_destination {
            modify {
                dkim $(primary_domain) $(local_domains) default
            }
            deliver_to &remote_queue
        }
    }
    default_source {
        reject 501 5.1.8 "Non-local sender domain"
    }
}

target.remote outbound_delivery {
    limits {
        # Up to 20 msgs/sec across max. 10 SMTP connections
        # for each recipient domain.
        destination rate 20 1s
        destination concurrency 10
    }
    mx_auth {
        dane
        mtasts {
            cache fs
            fs_dir mtasts_cache/
        }
        local_policy {
            min_tls_level encrypted
            min_mx_level none
        }
    }
}

target.queue remote_queue {
    target &outbound_delivery

    autogenerated_msg_domain $(primary_domain)
    bounce {
        destination postmaster $(local_domains) {
            deliver_to &local_routing
        }
        default_destination {
            reject 550 5.0.0 "Refusing to send DSNs to non-local addresses"
        }
    }
}

# ----------------------------------------------------------------------------
# IMAP endpoints

imap tls://0.0.0.0:{{.IMAPTLS}} tcp://0.0.0.0:{{.IMAPPort}} {
    auth &local_authdb
    storage &local_mailboxes
    insecure_auth {{if .AllowInsecureAuth}}yes{{else}}no{{end}}
{{if .EnableTURN}}
    turn_enable yes
    turn_server {{.PublicIP}}
    turn_port {{.TURNPort}}
    turn_secret {{.TURNSecret}}
    turn_ttl {{.TURNTTL}}
{{end}}
}

{{if .EnableTURN}}
# ----------------------------------------------------------------------------
# TURN server for video calls

turn udp://0.0.0.0:{{.TURNPort}} tcp://0.0.0.0:{{.TURNPort}} {
    realm {{.PublicIP}}
    secret {{.TURNSecret}}
    relay_ip {{.PublicIP}}
    debug {{if .Debug}}yes{{else}}no{{end}}
}
{{end}}

{{if .EnableChatmail}}
# ----------------------------------------------------------------------------
# Chatmail HTTP/HTTPS endpoint for user registration

# HTTP endpoint (port {{.ChatmailHTTPPort}})
chatmail tcp://0.0.0.0:{{.ChatmailHTTPPort}} {
    debug {{if .Debug}}yes{{else}}false{{end}}
    mail_domain $(primary_domain)
    mx_domain $(primary_domain)
    web_domain $(primary_domain)
    auth_db local_authdb
    storage local_mailboxes
    # Optional: customize password length (default: 16)
    password_length {{.ChatmailPasswordLen}}
    public_ip $(public_ip)
    turn_off_tls {{if .TurnOffTLS}}yes{{else}}no{{end}}
    enable_contact_sharing {{if .EnableContactSharing}}yes{{else}}no{{end}}

{{if .EnableSS}}
    ss_addr "{{.SSAddr}}"
    ss_password "{{.SSPassword}}"
    ss_cipher "{{.SSCipher}}"
{{else}}
    # Shadowsocks proxy for faster messaging (optional)
    # ss_addr 0.0.0.0:8388
    # ss_password somepassword
    # ss_cipher aes-128-gcm
{{end}}
}

# HTTPS endpoint (port {{.ChatmailHTTPSPort}}) - uncomment to enable
chatmail tls://0.0.0.0:{{.ChatmailHTTPSPort}} {
    debug {{if .Debug}}yes{{else}}false{{end}}
    mail_domain $(primary_domain)
    mx_domain $(primary_domain)
    web_domain $(primary_domain)
    auth_db local_authdb
    storage local_mailboxes
    # Optional: customize username length (default: 8)
    password_length {{.ChatmailPasswordLen}}
    tls file {{.TLSCertPath}} {{.TLSKeyPath}}
    public_ip $(public_ip)
    turn_off_tls {{if .TurnOffTLS}}yes{{else}}no{{end}}
    alpn_smtp submission
    alpn_imap imap
    enable_contact_sharing {{if .EnableContactSharing}}yes{{else}}no{{end}}

{{if .EnableSS}}
    ss_addr "{{.SSAddr}}"
    ss_password "{{.SSPassword}}"
    ss_cipher "{{.SSCipher}}"
{{else}}
    # Shadowsocks proxy for faster messaging (optional)
    # ss_addr 0.0.0.0:8388
    # ss_password somepassword
    # ss_cipher aes-128-gcm
{{end}}
}
{{end}}
