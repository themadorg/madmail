<!DOCTYPE html>
<html dir="rtl" lang="fa">

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, minimum-scale=1.0">
    <title>Ø³Ø±ÙˆØ± Ú†Øª {{.MailDomain | cleanDomain}}</title>
    <link rel="stylesheet" href="./main.css">
    <script src="./main.js"></script>
    <link rel="icon" href="/logo.svg">
    <style>
        body {
            font-family: Tahoma, Arial, sans-serif;
            text-align: center;
        }

        .cta-button {
            margin: 20px 0;
            cursor: pointer;
            border: none;
        }

        #account-result {
            display: none;
            margin: 20px auto;
            padding: 20px;
            border-radius: 12px;
            background: rgba(255, 255, 255, 0.05);
            max-width: 500px;
        }

        .manual-box {
            text-align: right;
            background: rgba(0, 0, 0, 0.2);
            padding: 15px;
            border-radius: 8px;
            margin-top: 30px;
            font-size: 0.9em;
            line-height: 1.8;
        }

        .copy-text {
            font-family: monospace;
            background: #000;
            padding: 5px;
            border-radius: 4px;
            color: #00d2ff;
            cursor: pointer;
            word-break: break-all;
            display: block;
            margin-top: 10px;
            direction: ltr;
        }

        #menu {
            justify-content: center;
        }

        #menu li {
            margin: 0 10px;
        }

        #domain {
            display: none;
        }
    </style>
</head>

<body>

    <ul id="menu">
        <li><a href="/">Ø§ØµÙ„ÛŒ</a></li>
        <li><a href="/share">Ø§Ø´ØªØ±Ø§Ú©â€ŒÚ¯Ø°Ø§Ø±ÛŒ</a></li>
        <li><a href="/info.html">Ø±Ø§Ù‡Ù†Ù…Ø§</a></li>
        <li><a href="/security.html">Ø§Ù…Ù†ÛŒØª</a></li>
        <li><a href="/deploy.html">Ø±Ø§Ù‡â€ŒØ§Ù†Ø¯Ø§Ø²ÛŒ</a></li>
    </ul>

    <h2>Ø³Ø±ÙˆØ± Ú†Øª {{.MailDomain | cleanDomain}}</h2>
    <p>Ø§ÛŒÙ† ÛŒÚ© Ø³Ø±ÙˆØ± Ø§Ø®ØªØµØ§ØµÛŒ Ø¨Ø±Ø§ÛŒ Ø§Ø³ØªÙØ§Ø¯Ù‡ Ø¯Ø± <strong>Ø¯Ù„ØªØ§Ú†Øª</strong> Ø§Ø³Øª.</p>

    {{if .RegistrationOpen}}
    <button class="cta-button" style="font-size: 0.9em; padding: 10px 20px;" onclick="generateAccount()"
        id="generate-btn">Ø³Ø§Ø®Øª Ø§Ú©Ø§Ù†Øª Ø¬Ø¯ÛŒØ¯</button>

    <div id="qr-container" style="display: none; margin: 20px 0;">
        <div style="background: white; padding: 10px; border-radius: 8px; display: inline-block;">
            <img id="result-qr" width="180" alt="QR Code" />
        </div>
    </div>

    <div id="loading-indicator" style="display: none; margin: 20px 0; color: #888;">
        Ø¯Ø± Ø­Ø§Ù„ Ø§ÛŒØ¬Ø§Ø¯ Ø§Ú©Ø§Ù†Øª...
    </div>
    <div id="error-message"
        style="display: none; margin: 20px auto; padding: 15px; background: rgba(255, 68, 68, 0.1); border: 1px solid rgba(255, 68, 68, 0.3); border-radius: 8px; max-width: 500px; color: #ff4444;">
    </div>
    <div id="deltachat-error"
        style="display: none; margin: 20px auto; padding: 15px; background: rgba(255, 200, 0, 0.1); border: 1px solid rgba(255, 200, 0, 0.3); border-radius: 8px; max-width: 500px; color: #ffc800;">
        <strong>Ø¯Ù„ØªØ§Ú†Øª Ù†ØµØ¨ Ù†Ø´Ø¯Ù‡ Ø§Ø³Øª</strong>
        <p style="margin-top: 10px; font-size: 0.9em;">Ù„Ø·ÙØ§Ù‹ Ø§Ø¨ØªØ¯Ø§ Ø§Ù¾Ù„ÛŒÚ©ÛŒØ´Ù† Ø¯Ù„ØªØ§Ú†Øª Ø±Ø§ Ù†ØµØ¨ Ú©Ù†ÛŒØ¯ Ùˆ Ø³Ù¾Ø³ Ø§Ø² Ø¯Ú©Ù…Ù‡ "Ú©Ù¾ÛŒ Ù„ÛŒÙ†Ú©"
            Ø§Ø³ØªÙØ§Ø¯Ù‡ Ú©Ù†ÛŒØ¯.</p>
    </div>

    <div id="account-result" style="display: none;">
        <div style="display: flex; gap: 10px; margin: 20px 0; justify-content: center; flex-wrap: wrap;">
            <button class="cta-button" onclick="openDeltaChat()" id="open-deltachat-btn"
                style="font-size: 0.9em; padding: 10px 20px;" disabled>ÙˆØ±ÙˆØ¯ Ø¨Ù‡ Ø¯Ù„ØªØ§Ú†Øª</button>
            <button class="cta-button" onclick="copyLink()" id="copy-link-btn"
                style="font-size: 0.9em; padding: 10px 20px; background: #444;" disabled>Ú©Ù¾ÛŒ Ù„ÛŒÙ†Ú©</button>
        </div>
    </div>

    <div class="manual-box">
        <strong>Ø±Ø§Ù‡Ù†Ù…Ø§ÛŒ Ø§ÙØ²ÙˆØ¯Ù† Ø¯Ø³ØªÛŒ (Ø§Ú¯Ø± Ø¯Ú©Ù…Ù‡ Ú©Ø§Ø± Ù†Ú©Ø±Ø¯):</strong>
        <ol>
            <li>Ø¯Ø± Ø¯Ù„ØªØ§Ú†Øª "Ø§ÛŒØ¬Ø§Ø¯ Ù¾Ø±ÙˆÙØ§ÛŒÙ„ Ø¬Ø¯ÛŒØ¯" (Create new profile) Ø±Ø§ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯.</li>
            <li>Ø³Ù¾Ø³ "Ø§Ø³ØªÙØ§Ø¯Ù‡ Ø§Ø² Ø³Ø±ÙˆØ± Ø¯ÛŒÚ¯Ø±" (Use Other server) Ø±Ø§ Ø¨Ø²Ù†ÛŒØ¯.</li>
            <li>Ø¹Ø¨Ø§Ø±Øª Ø²ÛŒØ± Ø±Ø§ Ú©Ù¾ÛŒ Ú©Ø±Ø¯Ù‡ Ùˆ Ø¯Ø± Ø¨Ø®Ø´ Ø§Ø³Ú©Ù† Ú©Ø¯ØŒ Ú¯Ø²ÛŒÙ†Ù‡ "Ø¬Ø§ÛŒÚ¯Ø°Ø§Ø±ÛŒ Ø§Ø² Ø­Ø§ÙØ¸Ù‡" (Paste from clipboard) Ø±Ø§ Ø¨Ø²Ù†ÛŒØ¯:</li>
        </ol>
        <p id="manual-link" dir="ltr" style="word-break: break-all; margin-top: 10px; color: #ccc; cursor: pointer;"
            onclick="copyText(this)"></p>
    </div>

    <div class="manual-box" style="background: rgba(255, 255, 255, 0.05); border-top: 1px solid #444;">
        <strong>Ù†Ú©ØªÙ‡ Ù…Ø®ØµÙˆØµ Ú©Ø§Ø±Ø¨Ø±Ø§Ù† iOS (Ø¢ÛŒÙÙˆÙ†):</strong>
        <p style="font-size: 0.9em; margin-top: 10px;">Ú©Ø§Ø±Ø¨Ø±Ø§Ù† Ø¢ÛŒÙÙˆÙ† Ø¨Ø§ÛŒØ¯ Ù„ÛŒÙ†Ú© Ø§Ø³ØªØ§Ù†Ø¯Ø§Ø±Ø¯ Ø¨Ø§Ù„Ø§ Ø±Ø§ Ú©Ù¾ÛŒ Ú©Ø±Ø¯Ù‡ Ùˆ Ø¯Ø± Ù‡Ù†Ú¯Ø§Ù…
            Ø³Ø§Ø®Øª Ø§Ú©Ø§Ù†Øª Ø¬Ø¯ÛŒØ¯ Ø¨Ù‡ Ø´Ú©Ù„ Ø²ÛŒØ± Ø¹Ù…Ù„ Ú©Ù†Ù†Ø¯:</p>
        <p dir="ltr" style="font-size: 0.85em;">new account > use other server > scan > paste</p>
        <p style="font-size: 0.85em; margin-top: 10px;">Ø§Ú¯Ø±Ú†Ù‡ Ú©Ù„ÛŒÚ© Ø±ÙˆÛŒ Ø¯Ú©Ù…Ù‡ ÙˆØ±ÙˆØ¯ Ø¯Ø± iOS Ù…Ù…Ú©Ù† Ø§Ø³Øª Ú©Ø§Ø± Ú©Ù†Ø¯ØŒ Ø§Ù…Ø§ Ø¨Ù‡ Ø¯Ù„ÛŒÙ„
            Ù…Ø­Ø¯ÙˆØ¯ÛŒØªâ€ŒÙ‡Ø§ÛŒ Ø³ÛŒØ³ØªÙ…â€ŒØ¹Ø§Ù…Ù„ØŒ Ø±ÙˆØ´ Ú©Ù¾ÛŒ Ùˆ Ø¬Ø§ÛŒÚ¯Ø°Ø§Ø±ÛŒ (Paste) Ù¾ÛŒØ´Ù†Ù‡Ø§Ø¯ Ù…ÛŒâ€ŒØ´ÙˆØ¯.</p>
    </div>

    {{if .SSURL}}
    <div class="ss-prominent-box shadow-lg border-accent">
        <strong>ğŸš€ Ø§ÙØ²Ø§ÛŒØ´ Ø³Ø±Ø¹Øª Ù¾ÛŒØ§Ù…â€ŒØ±Ø³Ø§Ù†ÛŒ</strong>
        <p>Ù„Ø·ÙØ§Ù‹ Ø¨Ø±Ø§ÛŒ ØªØ¬Ø±Ø¨Ù‡ Ø¨Ù‡ØªØ± Ùˆ Ø³Ø±Ø¹Øª Ø¨Ø§Ù„Ø§ØªØ±ØŒ Ø§Ø² Ø§ÛŒÙ† Ù¾Ø±ÙˆÚ©Ø³ÛŒ Ø¯Ø§Ø®Ù„ÛŒ Ø³Ø±ÙˆØ± Ø§Ø³ØªÙØ§Ø¯Ù‡ Ú©Ù†ÛŒØ¯.</p>

        <div class="ss-qr-container"
            style="margin: 20px 0; background: white; padding: 10px; border-radius: 12px; display: inline-block;">
            <img src="/qr?data={{.SSURL | urlquery}}" width="180" alt="Shadowsocks QR" style="display: block;" />
        </div>

        <div class="ss-copy-container">
            <p>Ù„ÛŒÙ†Ú© Shadowsocks (Ø¨Ø±Ø§ÛŒ Ú©Ù¾ÛŒ):</p>
            <div class="ss-copy-text" onclick="copyToClipboard('{{.SSURL}}')">{{.SSURL}}</div>
        </div>

        <p style="font-size: 0.85em; color: var(--text-secondary);">Ù†Ø­ÙˆÙ‡ Ø§Ø³ØªÙØ§Ø¯Ù‡: ØªÙ†Ø¸ÛŒÙ…Ø§Øª > Ù¾ÛŒØ´Ø±ÙØªÙ‡ > Ø´Ø¨Ú©Ù‡ > Ù¾Ø±ÙˆÚ©Ø³ÛŒ
            SOCKS5</p>

        <p style="font-size: 0.75em; color: #888; margin-top: 15px; opacity: 0.6;">
            * Ø§ÛŒÙ† Ù¾Ø±ÙˆÚ©Ø³ÛŒ ÙÙ‚Ø· Ø¯Ø± Ø§ÛŒÙ† Ø³Ø±ÙˆØ± Madmail Ú©Ø§Ø± Ù…ÛŒâ€ŒÚ©Ù†Ø¯.
        </p>
    </div>
    {{end}}

    <div
        style="margin-top: 40px; padding: 20px; background: var(--card-bg); border-radius: 12px; border: 1px solid rgba(255, 255, 255, 0.1);">
        <h3>Ø§Ø´ØªØ±Ø§Ú©â€ŒÚ¯Ø°Ø§Ø±ÛŒ Ø¢ÛŒâ€ŒØ¯ÛŒ</h3>
        <p style="margin-bottom: 20px;">Ø´Ù…Ø§ Ù…ÛŒâ€ŒØªÙˆØ§Ù†ÛŒØ¯ Ø¢ÛŒâ€ŒØ¯ÛŒ Ø¯Ù„ØªØ§Ú†Øª Ø®ÙˆØ¯ Ø±Ø§ Ø¨Ù‡ Ø§Ø´ØªØ±Ø§Ú© Ø¨Ú¯Ø°Ø§Ø±ÛŒØ¯ ØªØ§ Ø¯ÛŒÚ¯Ø±Ø§Ù† Ø¨ØªÙˆØ§Ù†Ù†Ø¯ Ø¨Ø§ Ø´Ù…Ø§
            ØªÙ…Ø§Ø³ Ø¨Ú¯ÛŒØ±Ù†Ø¯.</p>
        <div style="display: flex; gap: 15px; justify-content: center; flex-wrap: wrap;">
            <a href="/share" class="cta-button">Ø§Ø´ØªØ±Ø§Ú©â€ŒÚ¯Ø°Ø§Ø±ÛŒ Ø¢ÛŒâ€ŒØ¯ÛŒ Ù…Ù†</a>
        </div>
    </div>
    {{else}}
    <div
        style="margin: 60px auto; padding: 40px; background: rgba(255, 68, 68, 0.05); border: 1px solid rgba(255, 68, 68, 0.3); border-radius: 16px; max-width: 600px;">
        <h3 style="color: #ff4444; margin-top: 0; font-size: 1.5em;">Ø«Ø¨Øªâ€ŒÙ†Ø§Ù… Ø¨Ø³ØªÙ‡ Ø´Ø¯Ù‡ Ø§Ø³Øª</h3>
        <p style="line-height: 2; font-size: 1.1em; color: #eee;">
            Ø«Ø¨Øªâ€ŒÙ†Ø§Ù… Ú©Ø§Ø±Ø¨Ø± Ø¬Ø¯ÛŒØ¯ Ø¯Ø± Ø§ÛŒÙ† Ø³Ø±ÙˆØ± Ù…ÙˆÙ‚ØªØ§Ù‹ ØºÛŒØ±ÙØ¹Ø§Ù„ Ø´Ø¯Ù‡ Ø§Ø³Øª.
            Ù„Ø·ÙØ§Ù‹ Ø§Ø² Ø³Ø±ÙˆØ±Ù‡Ø§ÛŒ Ø¯ÛŒÚ¯Ø± Ø§Ø³ØªÙØ§Ø¯Ù‡ Ú©Ù†ÛŒØ¯.
        </p>
    </div>
    {{end}}

    <script>
        let currentLink = "";
        const registrationOpen = "{{if .RegistrationOpen}}true{{else}}false{{end}}" === "true";
        const jitEnabled = "{{if .JitRegistrationEnabled}}true{{else}}false{{end}}" === "true";

        function generateRandomString(length) {
            const charset = "abcdefghijklmnopqrstuvwxyz0123456789";
            let result = "";
            for (let i = 0; i < length; i++) {
                result += charset.charAt(Math.floor(Math.random() * charset.length));
            }
            return result;
        }

        function createDcloginLink(email, password) {
            const host = "{{.PublicIP | cleanDomain}}" || "{{.MXDomain | cleanDomain}}";
            const turnOffTLS = ("{{if .TurnOffTLS}}true{{else}}false{{end}}" === "true");

            if (turnOffTLS) {
                return `dclogin:${email}/?p=${encodeURIComponent(password)}&v=1&ih=${host}&ip=143&sh=${host}&sp=25&is=plain&ss=plain&sc=3`;
            } else {
                return `dclogin:${email}/?p=${encodeURIComponent(password)}&v=1&ih=${host}&ip=993&sh=${host}&sp=465&ic=3&ss=default`;
            }
        }

        function generateAccountRandom() {
            // Client-side random generation (JIT enabled)
            const username = generateRandomString(12);
            const password = generateRandomString(24);
            const email = formatEmail(username, "{{.MailDomain | cleanDomain}}");

            currentLink = createDcloginLink(email, password);

            document.getElementById('manual-link').innerText = currentLink;
            document.getElementById('result-qr').src = `/qr?data=${encodeURIComponent(currentLink)}`;
            document.getElementById('qr-container').style.display = 'block';
            document.getElementById('account-result').style.display = 'block';
            updateButtonStates();
        }

        function generateAccountAPI() {
            // Use /new API (JIT disabled but registration open)
            document.getElementById('account-result').style.display = 'none';
            document.getElementById('error-message').style.display = 'none';
            document.getElementById('loading-indicator').style.display = 'block';
            document.getElementById('generate-btn').disabled = true;

            fetch('/new', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                }
            })
                .then(response => {
                    if (!response.ok) {
                        if (response.status === 403) {
                            throw new Error('Ø«Ø¨Øªâ€ŒÙ†Ø§Ù… Ø¨Ø³ØªÙ‡ Ø´Ø¯Ù‡ Ø§Ø³Øª');
                        }
                        throw new Error('Ø®Ø·Ø§ Ø¯Ø± Ø§ÛŒØ¬Ø§Ø¯ Ø§Ú©Ø§Ù†Øª: ' + response.status);
                    }
                    return response.json();
                })
                .then(data => {
                    const email = data.email;
                    const password = data.password;

                    currentLink = createDcloginLink(email, password);

                    document.getElementById('manual-link').innerText = currentLink;
                    document.getElementById('result-qr').src = `/qr?data=${encodeURIComponent(currentLink)}`;
                    document.getElementById('qr-container').style.display = 'block';
                    document.getElementById('account-result').style.display = 'block';
                    document.getElementById('loading-indicator').style.display = 'none';
                    document.getElementById('generate-btn').disabled = false;
                    updateButtonStates();
                })
                .catch(error => {
                    document.getElementById('loading-indicator').style.display = 'none';
                    document.getElementById('error-message').style.display = 'block';
                    document.getElementById('error-message').innerText = error.message || 'Ø®Ø·Ø§ Ø¯Ø± Ø§Ø±ØªØ¨Ø§Ø· Ø¨Ø§ Ø³Ø±ÙˆØ±';
                    document.getElementById('generate-btn').disabled = false;
                });
        }

        function generateAccount() {
            // Choose method based on JIT status
            if (jitEnabled) {
                // JIT enabled: use client-side random generation
                generateAccountRandom();
            } else {
                // JIT disabled: use /new API
                generateAccountAPI();
            }
        }

        function updateButtonStates() {
            const hasLink = currentLink && currentLink.length > 0;
            document.getElementById('open-deltachat-btn').disabled = !hasLink;
            document.getElementById('copy-link-btn').disabled = !hasLink;
        }

        function openDeltaChat() {
            if (!currentLink) {
                document.getElementById('deltachat-error').style.display = 'block';
                return;
            }

            // Hide error message if it was shown
            document.getElementById('deltachat-error').style.display = 'none';

            // Track if DeltaChat opened successfully (page lost focus)
            let deltaChatOpened = false;
            let timeoutId = null;

            // Clean up function
            const cleanup = () => {
                if (timeoutId) {
                    clearTimeout(timeoutId);
                    timeoutId = null;
                }
                window.removeEventListener('blur', handleBlur);
                document.removeEventListener('visibilitychange', handleVisibilityChange);
            };

            // Detect if page loses focus (DeltaChat opened successfully)
            const handleBlur = () => {
                deltaChatOpened = true;
                cleanup();
            };

            const handleVisibilityChange = () => {
                if (document.hidden) {
                    deltaChatOpened = true;
                    cleanup();
                }
            };

            // Listen for focus/visibility changes
            // Note: These events may not fire reliably in all browsers, but it's the best we can do
            window.addEventListener('blur', handleBlur, { once: true });
            document.addEventListener('visibilitychange', handleVisibilityChange, { once: true });

            // Try to open DeltaChat using the protocol handler
            try {
                window.location.href = currentLink;
            } catch (e) {
                // If direct navigation fails, try creating a link element
                const link = document.createElement('a');
                link.href = currentLink;
                link.style.display = 'none';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            }

            // Fallback timeout: Show warning if DeltaChat didn't open after 2.5 seconds
            // This is a common pattern used by libraries like custom-protocol-detection
            // The timeout is short enough to not interfere with popup reading, but long enough
            // to detect if the protocol handler doesn't exist
            timeoutId = setTimeout(() => {
                cleanup();

                // Only show warning if DeltaChat didn't open (no blur event)
                // This means either:
                // 1. Protocol handler doesn't exist (no popup appeared)
                // 2. User dismissed popup (but we can't detect that reliably)
                if (!deltaChatOpened) {
                    document.getElementById('deltachat-error').style.display = 'block';
                }
            }, 2500);
        }

        function copyLink() {
            if (currentLink) {
                copyToClipboard(currentLink);
            }
        }

        function copyText(el) {
            copyToClipboard(el.innerText);
        }

        window.onload = function () {
            updateButtonStates();
            // Only auto-generate if registration is open AND JIT is enabled
            if (registrationOpen && jitEnabled) {
                generateAccount();
            }
        };
    </script>

    <footer
        style="margin-top: 50px; padding: 20px; font-size: 0.8em; color: #888; border-top: 1px solid rgba(255,255,255,0.1);">
        Ù†Ø³Ø®Ù‡ {{.Version}}
    </footer>
</body>

</html>