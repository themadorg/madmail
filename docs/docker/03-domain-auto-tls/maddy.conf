## Madmail Server - Domain with Auto-TLS (Let's Encrypt)
## Documentation: https://github.com/themadorg/madmail
##
## This example uses 'autocert' mode to automatically obtain and renew
## TLS certificates from Let's Encrypt via the HTTP-01 challenge.
##
## Requirements:
##   - A real domain name with DNS A record pointing to this server
##   - Port 80 open and reachable from the internet (for ACME challenges)
##   - Port 443 open (for HTTPS)
##
## How it works:
##   1. Maddy starts an HTTP server on port 80 for ACME challenge verification
##   2. On the first TLS connection, Let's Encrypt issues a certificate
##   3. Certificates are cached in /data/autocert/ and auto-renewed
##   4. Non-ACME HTTP requests on port 80 are redirected to HTTPS (302)
##
## Alternative: If you already have your own certificates (e.g., from certbot),
## you can use 'file' mode instead of 'autocert':
##
##   tls file /data/tls/fullchain.pem /data/tls/privkey.pem
##
## Just mount your cert files into the container via docker-compose volumes:
##   volumes:
##     - ./tls:/data/tls

$(hostname) = {env:MADDY_HOSTNAME}
$(primary_domain) = {env:MADDY_DOMAIN}
$(local_domains) = $(primary_domain)
$(public_ip) = {env:MADDY_PUBLIC_IP}

## TLS: Automatic Let's Encrypt via HTTP-01 challenge
## No DNS provider API token needed — just needs port 80 open.
## Certificates are cached in /data/autocert/ and auto-renewed.
tls {
    loader autocert {
        hostname {env:MADDY_HOSTNAME}
        email {env:MADDY_ACME_EMAIL}
        cache_dir /data/autocert
        agreed
    }
}

state_dir /data

# --- Local storage & authentication ---

auth.pass_table local_authdb {
    auto_create yes
    table sql_table {
        driver sqlite3
        dsn /data/credentials.db
        table_name passwords
    }
}

storage.imapsql local_mailboxes {
    auto_create yes
    driver sqlite3
    dsn /data/imapsql.db
}

# --- SMTP endpoints + message routing ---

hostname $(hostname)

table.chain local_rewrites {
    optional_step regexp "(.+)\+(.+)@(.+)" "$1@$3"
    optional_step static {
        entry postmaster postmaster@$(primary_domain)
    }
}

msgpipeline local_routing {
    destination postmaster $(local_domains) {
        modify {
            replace_rcpt &local_rewrites
        }
        deliver_to &local_mailboxes
    }

    default_destination {
        reject 550 5.1.1 "User doesn't exist"
    }
}

smtp tcp://0.0.0.0:25 {
    dmarc yes
    check {
        require_mx_record
        dkim
        spf
    }

    source $(local_domains) {
        reject 501 5.1.8 "Use Submission for outgoing SMTP"
    }
    default_source {
        destination postmaster $(local_domains) {
            deliver_to &local_routing
        }
        default_destination {
            reject 550 5.1.1 "User doesn't exist"
        }
    }
}

submission tls://0.0.0.0:465 tcp://0.0.0.0:587 {
    auth &local_authdb
    ## No explicit 'tls' directive needed — inherits global autocert config
    source $(local_domains) {
        check {
            authorize_sender {
                prepare_email &local_rewrites
                user_to_email identity
            }
        }
        destination postmaster $(local_domains) {
            deliver_to &local_routing
        }
        default_destination {
            modify {
                dkim $(primary_domain) $(local_domains) default
            }
            deliver_to &remote_queue
        }
    }
    default_source {
        reject 501 5.1.8 "Non-local sender domain"
    }
}

target.remote outbound_delivery {
    mx_auth {
        dane
        mtasts {
            cache fs
            fs_dir mtasts_cache/
        }
        local_policy {
            min_tls_level encrypted
            min_mx_level none
        }
    }
}

target.queue remote_queue {
    target &outbound_delivery
    autogenerated_msg_domain $(primary_domain)
    bounce {
        destination postmaster $(local_domains) {
            deliver_to &local_routing
        }
        default_destination {
            reject 550 5.0.0 "Refusing to send DSNs to non-local addresses"
        }
    }
}

# --- IMAP endpoints ---
## No explicit 'tls' directive — inherits global autocert config

imap tls://0.0.0.0:993 tcp://0.0.0.0:143 {
    auth &local_authdb
    storage &local_mailboxes
}

# --- Chatmail / Admin API ---
#
# In autocert mode, port 80 is owned by the ACME HTTP-01 challenge handler.
# Non-ACME requests on port 80 are automatically redirected to HTTPS (302).
# Therefore, we only configure the HTTPS endpoint on port 443.

chatmail tls://0.0.0.0:443 {
    # --- Required Settings ---
    mail_domain $(primary_domain)
    mx_domain $(hostname)
    web_domain $(hostname)
    public_ip $(public_ip)
    auth_db local_authdb
    storage local_mailboxes
    ## No explicit 'tls' directive — inherits global autocert config

    # --- Optional Core Settings ---
    # debug no                       # Enable debug logging for this module
    # username_length 8              # Length of generated usernames
    # password_length 16             # Length of generated passwords
    # max_message_size 32M           # Max size of incoming HTTP emails
    # turn_off_tls no                # Disable TLS requirements for client links
    # www_dir ""                     # Custom directory for static files

    # --- Admin API Settings ---
    # admin_token "token"            # Static API token (autogenerated if empty, use "disabled" to disable)
    # admin_path "/api/admin"        # Base path for the admin API

    # --- Shadowsocks Settings ---
    # To disable Shadowsocks, comment out or remove the ss_addr line below.
    ss_addr 0.0.0.0:1080             # Address for Shadowsocks to listen on
    # ss_password "default-pass"     # Password for Shadowsocks
    # ss_cipher aes-128-gcm          # Cipher method (default: aes-128-gcm)
    # ss_allowed_ports 25 143 465 587 993  # Ports allowed to be relayed via proxy

    # --- Contact Sharing Settings ---
    # enable_contact_sharing yes     # Enable the /share endpoint
    # sharing_driver "sqlite3"       # GORM driver for sharing database
    # sharing_dsn "sharing.db"       # DSN for sharing database

    # --- Advanced ALPN Multiplexing ---
    # alpn_smtp "endpoint.smtp"      # Name of SMTP module for ALPN routing
    # alpn_imap "endpoint.imap"      # Name of IMAP module for ALPN routing
}
